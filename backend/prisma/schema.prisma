// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @db.Uuid // Linked to auth.users.id
  name      String?
  email     String   @unique
  role      String   @default("SUPPLIER") // ADMIN, SUPPLIER
  status    String   @default("ACTIVE")
  expoPushToken String?
  suppliers Supplier[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Plan {
  id           String     @id @default(uuid())
  name         String
  monthlyPrice Float
  cycleDays    Int        @default(30)
  // Business rules
  limitProducts   Int      @default(100)
  limitOrders     Int      @default(1000)
  commissionPercent Float  @default(10.0)
  priorityLevel   Int      @default(1)
  
  // Financial Limits
  withdrawalLimit Int      @default(4) // Withdrawals per month
  minWithdrawal   Float    @default(50.0)
  releaseDays     Int      @default(14) // D+14 default
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  suppliers    Supplier[]
  subscriptions SupplierSubscription[]
}

model FinancialSettings {
  id              String   @id @default("global")
  defaultReleaseDays Int @default(14)
  defaultMinWithdrawal Float @default(50.0)
  defaultWithdrawalLimit Int @default(4)
  updatedAt       DateTime @updatedAt
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  adminName String
  action    String   // APPROVE_WITHDRAWAL, REJECT_WITHDRAWAL, UPDATE_SETTINGS
  targetId  String?  // ID of the affected entity (WithdrawalRequest, Supplier, etc.)
  details   String?  // JSON string or description
  reason    String?  // Mandatory for rejections
  createdAt DateTime @default(now())
}

model Supplier {
  id              String    @id @default(uuid())
  name            String
  integrationType String    // MANUAL, API
  shippingDeadline Int?     // Days
  status          String    @default("ACTIVE") // ACTIVE, PAUSED
  
  userId          String?   @db.Uuid
  user            User?     @relation(fields: [userId], references: [id])
  
  // Financial Fields
  planId          String?
  plan            Plan?     @relation(fields: [planId], references: [id])
  financialStatus String    @default("ACTIVE") // ACTIVE, SUSPENDED, OVERDUE
  commissionRate  Float     @default(10.0) // Percentage
  
  // Wallet Balances
  walletBalance   Float     @default(0.0) // AVAILABLE
  pendingBalance  Float     @default(0.0) // PENDING RELEASE
  blockedBalance  Float     @default(0.0) // BLOCKED / IN WITHDRAWAL
  
  verificationStatus String @default("PENDING") // PENDING, VERIFIED, REJECTED

  nextBillingDate DateTime?
  scheduledPlanId String?

  // Billing Info
  billingName     String?
  billingDoc      String?
  billingAddress  String?
  billingEmail    String?

  products        ProductSupplier[]
  orders          Order[]
  ledger          FinancialLedger[]
  subscriptions   SupplierSubscription[]
  withdrawals     WithdrawalRequest[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model Product {
  id               String   @id @default(uuid())
  name             String
  sku              String   @unique
  description      String?
  imageUrl         String?
  
  // Agregated fields
  stockAvailable   Int      @default(0) // Sum of (virtualStock - safetyStock) from all suppliers
  
  suppliers        ProductSupplier[]

  marginType       String   @default("FIXED") // FIXED, DYNAMIC
  marginValue      Float    @default(0) 
  finalPrice       Float
  
  mercadoLivreId   String?  // ID do anúncio no ML
  mercadoLivreStatus String? // active, paused, closed
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  OrderItem        OrderItem[]
  InventoryLog     InventoryLog[]
}

model InventoryLog {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      // Change amount (+/-)
  type      String   // SALE, RESTOCK, ADJUSTMENT, RETURN, CANCEL
  reason    String?
  userId    String?  // Who performed the action (optional)
  createdAt DateTime @default(now())
}

model WithdrawalRequest {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  amount      Float
  pixKey      String?  // Chave PIX ou dados bancários para pagamento
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, PAID
  notes       String?
  requestedAt DateTime @default(now())
  processedAt DateTime?
  processedBy String?  // Admin ID
}

model ProductSupplier {
  id             String   @id @default(uuid())
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  supplierId     String
  supplier       Supplier @relation(fields: [supplierId], references: [id])
  
  supplierPrice  Float
  virtualStock   Int      @default(0)
  safetyStock    Int      @default(0)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([productId, supplierId])
}

model Order {
  id              String      @id @default(uuid())
  mercadoLivreId  String?     @unique
  status          String      @default("NEW") // NEW, SENT_TO_SUPPLIER, SHIPPING, DELIVERED, CANCELLED
  totalAmount     Float
  trackingCode    String?
  customerName    String?
  customerAddress String?
  items           OrderItem[]
  
  // Financial Fields
  supplierId         String?     // Linked supplier for this order
  supplier           Supplier?   @relation(fields: [supplierId], references: [id])
  marketplaceFee     Float       @default(0.0)
  platformCommission Float       @default(0.0)
  supplierPayout     Float       @default(0.0)
  financialStatus    String      @default("PENDING") // PENDING, RELEASED, CANCELLED
  
  financialLedger    FinancialLedger[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
}

model FinancialLedger {
  id          String   @id @default(uuid())
  type        String   // SUBSCRIPTION_PAYMENT, SALE_COMMISSION, PAYOUT, ADJUSTMENT
  amount      Float
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  orderId     String?
  order       Order?   @relation(fields: [orderId], references: [id])
  description String?
  status      String   @default("COMPLETED") // COMPLETED, PENDING
  releaseDate DateTime? // Date when funds become available
  createdAt   DateTime @default(now())
}

model SupplierSubscription {
  id            String   @id @default(uuid())
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  planId        String
  plan          Plan     @relation(fields: [planId], references: [id])
  startDate     DateTime
  endDate       DateTime
  status        String   // ATIVA | PENDENTE | VENCIDA | SUSPENSA
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([supplierId, status])
}
model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   // STOCK, ORDER, INFO
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Integration {
  id           String   @id @default(uuid())
  provider     String   @unique // "MERCADOLIVRE"
  accessToken  String
  refreshToken String
  expiresIn    Int
  userId       String   // External User ID (Seller ID)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Log {
  id        String   @id @default(uuid())
  level     String   // INFO, ERROR, WARN
  message   String
  context   String?  // JSON string for details
  createdAt DateTime @default(now())
}
