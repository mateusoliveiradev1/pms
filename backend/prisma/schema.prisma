// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @db.Uuid // Linked to auth.users.id
  name      String?
  email     String   @unique
  role      String   @default("SUPPLIER") // ADMIN, SUPPLIER
  status    String   @default("ACTIVE")
  expoPushToken String?
  suppliers Supplier[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Plan {
  id           String     @id @default(uuid())
  name         String
  monthlyPrice Float
  cycleDays    Int        @default(30)
  // Business rules
  limitProducts   Int      @default(100)
  limitOrders     Int      @default(1000)
  commissionPercent Float  @default(10.0)
  priorityLevel   Int      @default(1)
  
  // Financial Limits
  withdrawalLimit Int      @default(4) // Withdrawals per month
  minWithdrawal   Float    @default(50.0)
  releaseDays     Int      @default(14) // D+14 default
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  suppliers    Supplier[]
  subscriptions SupplierSubscription[]
}

model FinancialSettings {
  id              String   @id @default("global")
  defaultReleaseDays Int @default(14)
  defaultMinWithdrawal Float @default(50.0)
  defaultWithdrawalLimit Int @default(4)
  updatedAt       DateTime @updatedAt
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  adminName String
  action    String   // APPROVE_WITHDRAWAL, REJECT_WITHDRAWAL, UPDATE_SETTINGS
  targetId  String?  // ID of the affected entity (WithdrawalRequest, Supplier, etc.)
  details   String?  // JSON string or description
  reason    String?  // Mandatory for rejections
  createdAt DateTime @default(now())
}

model ProcessedWebhookEvent {
  id          String   @id @default(uuid())
  gateway     String   // STRIPE, MERCADO_PAGO
  eventId     String   @unique // Source of Truth
  processedAt DateTime @default(now())

  @@index([eventId])
}

model Supplier {
  id              String    @id @default(uuid())
  name            String
  integrationType String    // MANUAL, API
  shippingDeadline Int?     // Days
  status          String    @default("ACTIVE") // ACTIVE, PAUSED
  
  userId          String?   @db.Uuid
  user            User?     @relation(fields: [userId], references: [id])
  
  // Financial Fields
  planId          String?
  plan            Plan?     @relation(fields: [planId], references: [id])
  financialStatus String    @default("ACTIVE") // ACTIVE, SUSPENDED, OVERDUE
  commissionRate  Float     @default(10.0) // Percentage
  
  // Wallet Balances
  walletBalance   Float     @default(0.0) // AVAILABLE
  pendingBalance  Float     @default(0.0) // PENDING RELEASE
  blockedBalance  Float     @default(0.0) // BLOCKED / IN WITHDRAWAL
  
  verificationStatus String @default("PENDING") // PENDING, VERIFIED, REJECTED

  nextBillingDate DateTime?
  scheduledPlanId String?

  // Billing Info
  billingName     String?
  billingDoc      String?
  billingAddress  String?
  billingEmail    String?

  products        ProductSupplier[]
  orders          Order[]
  subscriptions   SupplierSubscription[]
  financialLedger FinancialLedger[]
  withdrawals     WithdrawalRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupplierSubscription {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id])
  
  status      String   @default("PENDING") // PENDING, ACTIVE, CANCELLED, PAST_DUE
  startDate   DateTime @default(now())
  endDate     DateTime

  // Payment Info
  gateway          String?  // MERCADO_PAGO, STRIPE, MANUAL
  externalId       String?  // Subscription ID or Payment Intent ID
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Integration {
  id           String   @id @default(uuid())
  provider     String   @unique
  accessToken  String
  refreshToken String
  expiresIn    Int
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Product {
  id                 String   @id @default(uuid())
  sku                String   @unique
  name               String
  description        String?
  imageUrl           String?
  price              Float
  marginType         String?  // FIXED, PERCENTAGE
  marginValue        Float?
  stockAvailable     Int      @default(0)
  mercadoLivreId     String?
  mercadoLivreStatus String?
  
  suppliers          ProductSupplier[]
  orderItems         OrderItem[]
  inventoryLogs      InventoryLog[]
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model InventoryLog {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  type      String
  reason    String?
  createdAt DateTime @default(now())
}

model ProductSupplier {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  externalId String
  price      Float
  stock      Int
  virtualStock Int    @default(0)
  safetyStock  Int    @default(0)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([supplierId, externalId])
}

model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  status          String   @default("PENDING") // PENDING, PAID, SHIPPED, DELIVERED, CANCELLED
  totalAmount     Float
  customerName    String?
  shippingAddress String?
  
  // Payment Info
  paymentGateway    String?   // MERCADOPAGO, STRIPE
  paymentExternalId String?   @unique
  paymentStatus     String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paidAt            DateTime?

  // Financial Info
  commissionValue Float    @default(0.0)
  netValue        Float    @default(0.0) // Amount for Supplier
  payoutStatus    String   @default("PENDING") // PENDING, RELEASED, PAID

  items           OrderItem[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  sku       String
  quantity  Int
  unitPrice Float
  total     Float
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
}

model FinancialLedger {
  id              String   @id @default(uuid())
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  type            String   // SALE_REVENUE, COMMISSION_DEBIT, WITHDRAWAL, SUBSCRIPTION_PAYMENT, ADJUSTMENT
  amount          Float    // Positive for credit, Negative for debit
  status          String   @default("COMPLETED") // PENDING, COMPLETED, RELEASED
  description     String?
  
  // Release Logic
  releaseDate     DateTime? 
  referenceId     String?  // Order ID, Withdrawal ID, etc.
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WithdrawalRequest {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  amount      Float
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, PAID
  pixKey      String?
  bankInfo    String?
  
  requestedAt DateTime @default(now())
  processedAt DateTime?
  adminNote   String?
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   // ORDER, SYSTEM, ALERT
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model InternalWebhook {
  id              String   @id @default(uuid())
  url             String
  secret          String
  isActive        Boolean  @default(true)
  subscribedEvents String[] // Array of event names
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  logs            WebhookLog[]
}

model WebhookLog {
  id          String   @id @default(uuid())
  webhookId   String
  webhook     InternalWebhook @relation(fields: [webhookId], references: [id])
  event       String
  payload     Json?
  statusCode  Int?
  success     Boolean
  error       String?
  attempt     Int      @default(1)
  createdAt   DateTime @default(now())
}
